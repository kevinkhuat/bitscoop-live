#!/bin/bash


# Set this to the folder where the "ografy" folder lives.
REPO=${HOME}/Development/Repositories
# Set this to the directory where the tarballs should be created.
PKG=${HOME}/Development/Packages
# Set this to the directory where ssh keys are stored.
KEYDIR=${HOME}/Keys/ssh


case ${1} in
    production)
        echo "Are you sure you want to deploy tarballs to aws?"

        select yn in "No" "Yes"; do
            case ${yn} in
                Yes) break;;
                No) exit 0;;
            esac
        done

        echo "Using aws settings to deploy."

        KEY=${KEYDIR}/ografy.io.pem
        USER=ec2-user
        SERVER=ografy.io
        ;;
    virtual)
        echo "Using virtual settings to deploy."

        KEY=${KEYDIR}/virtual.ografy.io.pem
        USER=ec2-user
        SERVER=virtual.ografy.io
        ;;
    *)
        echo "Usage: deploy {production|virtual}"
        exit 2
        ;;
esac


# Remove tarballs from previous run.
rm $PKG/ografy.tar.gz 2> /dev/null
rm $PKG/infrastructure.tar.gz 2> /dev/null


# Create ografy and deploy script tarballs.
cd $REPO
tar -czf $PKG/ografy.tar.gz --exclude .git --exclude .idea --exclude ografy/infrastructure --exclude __pycache__ --exclude *.pyc ografy

cd ografy
tar -czf $PKG/infrastructure.tar.gz --exclude .git --exclude .idea infrastructure


scp -i ${KEY} $PKG/infrastructure.tar.gz $PKG/ografy.tar.gz ${USER}@${SERVER}:~
